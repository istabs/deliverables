<!doctype html>
<html lang=pt>

<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

	<title id="titleTag">IST delivery schedule</title>
	<meta name="description" content="IST deliverables">
	<meta name="author" content="ABS">

	<!-- IMPORTS -->
	<link rel="shortcut icon" type="image/x-icon" href="favicon.ico">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.4.1/css/bootstrap.min.css">
	<link href="https://cdnjs.cloudflare.com/ajax/libs/tabulator/4.4.3/css/tabulator.min.css" rel="stylesheet">
	<link href="https://istabs.github.io/deliverables/deliverables_style.css" rel="stylesheet">
	<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.js"></script>
	<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.4.1/js/bootstrap.bundle.min.js"></script>
	<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/sprintf/1.1.2/sprintf.min.js"></script>
	<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/tabulator/4.4.3/js/tabulator.min.js"></script>
	<script type="text/javascript" src="https://istabs.github.io/deliverables/date_extensions.js"></script>
	<script type="text/javascript" src="https://istabs.github.io/deliverables/deliverables_support.js"></script>
</head>

<body>

	<div class="container-fluid">
		<div id="dropInvalidFileMsgHere">
			<h1 id = "dropTitleHere"></h1>
			<p>Now: <span id="dropDateHere"></span> | Next delivery in: <span id="dropNextDueHere"></span></p>
			<div id="dropScheduleHere"></div>
			<div id="dropLinksHere"></div>
		</div>
	</div>

	<script>
		// ?data=2020s2.json
		var urlParameters = new URLSearchParams(window.location.search);
		if (! urlParameters.has("data")) {
			document.getElementById("dropInvalidFileMsgHere").innerHTML = "Invalid resource format";
		} else {
			var dataUrl = urlParameters.get("data");
			$.getJSON(dataUrl)
			.then((data) => {

				for (i = 0; i < data.length; i++) {
					if (data[i].hasOwnProperty("rel") && data[i].rel === "title")
						document.getElementById("dropTitleHere").innerHTML = data[i].value;
				}

				let deliverables = [], ucs = [], links = [];
				for (i = 0; i < data.length; i++) {
					if (data[i].target == "deliverables") deliverables = data[i].values;
					if (data[i].target == "ucs") ucs = data[i].values;
					if (data[i].target == "links") links= data[i].links;
				}

				let composeTable = function (data) {
					let ucsDict = [], deliverables = [];
					for (j = 0; j < data.length; j++) {
						if (data[j].rel === "ucs") {
							var ucs = data[j].values;
							for (i = 0; i < ucs.length; i++) {
								ucsDict[ucs[i].uc] = ucs[i]
							}
						}
						if (data[j].rel === "deliverables") {
							deliverables = data[j].values;
						}
					}
					let tableData = []
					for (i = 0; i < deliverables.length; i++) {
						let _dueDate = new Date(deliverables[i].dueDate)
						let _dueDateString = sprintf('%04d/%02d/%02d %02d:%02d (w%s, %s)', _dueDate.getFullYear(), _dueDate
						.getMonthNr(),
						_dueDate.getDate(), _dueDate.getHours(), _dueDate.getMinutes(), _dueDate.getWeekNr(), _dueDate
						.getWeekDay())
						let _deltaDays = new Date().diff(_dueDate);
						let isFuture = new Date().isFuture(_dueDate);
						if (isFuture) {
							tableData.push({
								uc: deliverables[i].uc,
								uc_link: "href" in ucsDict[deliverables[i].uc] ? ucsDict[deliverables[i].uc].href : "#",
								deliverable: deliverables[i].deliverable,
								link: "href" in deliverables[i] ? deliverables[i].href : "goback.html",
								type: deliverables[i].type,
								days: _deltaDays,
								timer: _deltaDays,
								dueDate: _dueDateString
							})
						}
					}
					normalizeTimer(tableData)
					return tableData
				}

				var tabulator = new Tabulator("#dropScheduleHere", {
					layout: "fitDataFill",
					data: composeTable(data),
					tooltips: false,
					movableColumns: true,
					responsiveLayout: "hide",
					height: 561,
					initialSort: [{
						column: "timer",
						dir: "asc"
					}],
					columns: [
						{ title: "UC", field: "uc", width: 60, headerFilter: true, formatter: "link", formatterParams: {labelField: "uc", target: "_blank", urlField: "uc_link" }},
						{ title: "Deliverable", field: "deliverable", formatter: "link", formatterParams: {labelField: "deliverable", target: "_blank", urlField: "link" }},
						{ title: "Deliverable Type", field: "type", width: 112, },
						{ title: "Due date", field: "dueDate", },
						{ title: "Days left", field: "days", align: "right", width: 75, },
						{ title: "Timer", field: "timer", minWidth: 280, formatter: "progress", align: "right", },
					],
				});
				return data;
			})
			.then((data) => {

				let ucs = [], links = [];
				for (i = 0; i < data.length; i++) {
					if (data[i].rel == "ucs") ucs = data[i].values;
					if (data[i].rel == "links") links = data[i].values;
				}

				var html_links = "<h2>Links</h2><ul>"
				for (i = 0; i < links.length; i++) {
					html_links += '<li><a href="' + links[i].href + '" target="_blank">' + links[i].description + '</a></li>'
				}
				html_links += "</ul>"
				document.getElementById("dropLinksHere").innerHTML = html_links;
				return data;
			})
			.then((data) => {

				function getCustomNow() {
					var today = new Date();
					var year = today.getFullYear();
					var month = today.getMonthNr();
					var day = today.getDate();
					var weeknr = today.getWeekNr();
					var weekday = today.getWeekDay();
					var hours = today.getHours();
					var mins = today.getMinutes();
					return {
						weeknr: weeknr,
						weekday: weekday,
						year: year,
						month: month,
						day: day,
						hours: hours,
						mins: mins
					}
				}
				
				const oneMin = 60000;
				const oneHour = oneMin * 60;
				const oneDay = oneHour * 24;

				function getNextDue(deliverables) {
					var today = new Date();
					var dueDate = new Date(2099, 1, 1, 0, 0, 0);
					for (i = 0; i < deliverables.length; i++) {
						var recDate = new Date(deliverables[i].dueDate.substring(0, 16))
						if (recDate < today) continue;
						if (recDate < dueDate) dueDate = recDate;
					}
					var delta = dueDate.getTime() - today.getTime();
					var deltaDays = Math.floor(delta / oneDay);
					var deltaHours = Math.floor((delta - (deltaDays * oneDay)) / oneHour);
					var deltaMins = Math.floor((delta - deltaDays * oneDay - deltaHours * oneHour) / oneMin);
					return sprintf('%02s day%s %02sh %02sm', deltaDays, deltaDays == 1 ? "" : "s", deltaHours, deltaMins);
				}
				
				let deliverables = [];
				for (i = 0; i < data.length; i++) {
					if (data[i].rel == "deliverables") deliverables = data[i].values;
				}

				let formatTagTime = (hours, minutes) => sprintf('%02u:%02u', hours, minutes);
				let formatScrTime = (now) => sprintf('week %02s - %s, %s/%02s/%02s <strong><a href="%s">%02s:%02s</a></strong>',
					now.weeknr, now.weekday, now.year, now.month, now.day, "https://istabs.github.io/deliverables/clock/",
					now.hours, now.mins);

				let timeLoop = () => {
					let now = getCustomNow();
					let nxtDel = getNextDue(deliverables);
					document.getElementById("titleTag").innerHTML = sprintf("IST %s / %s", formatTagTime(now.hours, now.mins), nxtDel);
					document.getElementById("dropDateHere").innerHTML = formatScrTime(now);
					document.getElementById("dropNextDueHere").innerHTML = sprintf('<strong>%s</strong>', nxtDel);
				};

				timeLoop();
				setInterval(() => timeLoop(), 1000);
			})
			.catch((err) => {
				document.getElementById("dropInvalidFileMsgHere").innerHTML = "Invalid resource specified; indicate ?/data=<resource>";
				console.log('Errors!', err);
				}
			);
		}
	</script>
</body>
</html>