<!doctype html>
<html lang=pt>

<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

	<title id="titleTag">IST delivery schedule</title>
	<meta name="description" content="IST deliverables">
	<meta name="author" content="ABS">

	<!-- IMPORTS -->
	<link rel="shortcut icon" type="image/x-icon" href="favicon.ico">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.4.1/css/bootstrap.min.css">
	<link href="https://cdnjs.cloudflare.com/ajax/libs/tabulator/4.4.3/css/tabulator.min.css" rel="stylesheet">
	<link href="https://istabs.github.io/deliverables/deliverables_style.css" rel="stylesheet">
	<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.js"></script>
	<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.4.1/js/bootstrap.bundle.min.js"></script>
	<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/sprintf/1.1.2/sprintf.min.js"></script>
	<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/tabulator/4.4.3/js/tabulator.min.js"></script>
	<script type="text/javascript" src="https://istabs.github.io/deliverables/date_extensions.js"></script>
	<script type="text/javascript" src="https://istabs.github.io/deliverables/deliverables_support.js"></script>
</head>

<body>
	<div class="container-fluid">
		<h1>IST/MEIC ABS delivery schedule</h1>
		<p>Now: <span id="dropDateHere"></span> | Next delivery in: <span id="dropNextDueHere"></span></p>
		<div id="dropScheduleHere"></div>
		<div id="dropLinksHere"></div>
	</div>

	<script>
		var genDataFilename = () => {
			var today = new Date();
			var year = today.getFullYear();
			var month = today.getMonth();
			var semester = month > 1 && month < 6 ? 2 : 1;
			var lectiveYear = year - (semester == 1 && month > 8 ? 1 : 0);
			return '' + lectiveYear + '_' + semester + ".json";
		}
	</script>
	<script>
		// ?data=2020_2.json
		var urlParameters = new URLSearchParams(window.location.search);
		if (urlParameters.has("data")) {
			var dataUrl = urlParameters.get("data");
			console.log("dataUrl");
			console.log(dataUrl);
			$.getJSON(dataUrl)
			.then((data) => {
				console.log(data);
				var ucs = [];
				for (i = 0; i < data.length; i++) {
					if (data.target[i] == "ucs") ucs.push(data.values);
				}
				console.log(ucs);
			});
		}
	</script>
	<script>
		var files = ["fenix_links.json", genDataFilename()];
		Promise.all(files.map(async (file) => {
			let res = {};
			res["file"] = file;
			res["response"] = await(fetch(file));
			return res;
		})).then((responses) => {
			return Promise.all(responses.map(async (response) => {
				let res = {};
				res["file"] = response["file"];
				res["json"] = await(response["response"]).json();
				return res;
			}));
		})
		.then((jsonMap) => {

			var dataFileName = genDataFilename();
			var ucs = [];
			var json = [];
			for (i = 0; i < jsonMap.length; i++) {
				if (jsonMap[i]["file"] == "fenix_links.json") ucs = jsonMap[i]["json"]
				if (jsonMap[i]["file"] == dataFileName) json = jsonMap[i]["json"]
			}
			var ucsMap = {};
			for (i = 0; i < ucs.length; i++) {
				ucsMap[ucs[i]["uc"]] = ucs[i];
			}
			var tabulator = new Tabulator("#dropScheduleHere", {
				layout: "fitDataFill",
				data: extractData(ucs, json),
				tooltips: false,
				movableColumns: true,
				responsiveLayout: "hide",
				height: 560,
				initialSort: [{
					column: "timer",
					dir: "asc"
				}],
				columns: [
					{ title: "UC", field: "uc", width: 60, headerFilter: true, formatter: "link", formatterParams: {labelField: "uc", target: "_blank", urlField: "uc_link" }},
					{ title: "Deliverable", field: "deliverable", formatter: "link", formatterParams: {labelField: "deliverable", target: "_blank", urlField: "link" }},
					{ title: "Deliverable Type", field: "type", width: 112, },
					{ title: "Due date", field: "dueDate", },
					{ title: "Days left", field: "days", align: "right", width: 75, },
					{ title: "Timer", field: "timer", minWidth: 280, formatter: "progress", align: "right", },
				],
			});
			return jsonMap;
		}).then((jsonMap) => {
			var json = [];
			var dataFileName = genDataFilename();
			for (i = 0; i < jsonMap.length; i++) {
				if (jsonMap[i]["file"] == "fenix_links.json") ucs = jsonMap[i]["json"]
				if (jsonMap[i]["file"] == dataFileName) json = jsonMap[i]["json"]
			}
			var links = extractLinks(json);
			var html_links = "<h2>Links</h2><ul>"
			for (i = 0; i < links.length; i++) {
				html_links += '<li><a href="' + links[i].link + '" target="_blank">' + links[i].text + '</a></li>'
			}
			html_links += "</ul>"
			document.getElementById("dropLinksHere").innerHTML = html_links;

			function put0X(nr) {
				return "" + (nr < 10 ? "0" : "") + nr;
			}

			function formPlural(nr, term) {
				if (nr <= 0) return "";
				if (nr == 1) return "" + nr + " " + term + " ";
				return "" + nr + " " + term + "s ";
			}

			function getCustomNow() {
				var today = new Date();
				var year = today.getFullYear();
				var month = today.getMonthNr();
				var day = today.getDate();
				var weeknr = today.getWeekNr();
				var weekday = today.getWeekDay();
				var hours = today.getHours();
				var mins = today.getMinutes();
				return {
					weeknr: weeknr,
					weekday: weekday,
					year: year,
					month: month,
					day: day,
					hours: hours,
					mins: mins
				}
			}
			
			const oneMin = 60000;
			const oneHour = oneMin * 60;
			const oneDay = oneHour * 24;

			function getNextDue() {
				var today = new Date();
				var data = extractData(ucs, json);
				var dueDate = new Date(2099, 1, 1, 0, 0, 0);
				for (i = 0; i < data.length; i++) {
					var recDate = new Date(data[i].dueDate.substring(0, 16))
					if (recDate < today) continue;
					if (recDate < dueDate) dueDate = recDate;
				}
				var delta = dueDate.getTime() - today.getTime();
				var deltaDays = Math.floor(delta / oneDay);
				var deltaHours = Math.floor((delta - (deltaDays * oneDay)) / oneHour);
				var deltaMins = Math.floor((delta - deltaDays * oneDay - deltaHours * oneHour) / oneMin);
				return "<strong>" + formPlural(deltaDays, "day") + put0X(deltaHours) + "h" + put0X(deltaMins) + "</strong>";
			}
			
			var formatTagTime = (hours, minutes) => sprintf('%02u:%02u', hours, minutes);
			var formatScrTime = (now) => sprintf('week %02s - %s, %s/%02s/%02s <strong><a href="%s">%02s:%02s</a></strong>', now.weeknr, now.weekday, now.year, now.month, now.day, "https://istabs.github.io/deliverables/clock/", now.hours, now.mins);

			var timeLoop = () => {
				var now = getCustomNow();
				document.getElementById("titleTag").innerHTML = "IST " + formatTagTime(now.hours, now.mins);
				document.getElementById("dropDateHere").innerHTML = formatScrTime(now);
				document.getElementById("dropNextDueHere").innerHTML = getNextDue();
			}

			timeLoop();
			setInterval(() => timeLoop(), 1000);
		})
		.catch((err) => console.log('Errors!', err));
	</script>
</body>
</html>